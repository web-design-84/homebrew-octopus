#!/bin/zsh

#-------------------------------
# octopus ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹
#-------------------------------

function octopus_init() {
  # å¿…é ˆã‚³ãƒãƒ³ãƒ‰ãŒãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¿ƒã™
  if [[ ! $(command -v docker) ]]; then
    echo 'octopus ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ docker ãŒå¿…è¦ã§ã™ã€‚'
    echo 'ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ docker ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚\n'
    echo 'brew install --cask docker\n'
    exit 1
  fi

  if [[ ! $(command -v mkcert) ]]; then
    echo 'octopus ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ mkcert ãŒå¿…è¦ã§ã™ã€‚'
    echo 'ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ mkcert ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚\n'
    echo 'brew install mkcert'
    echo 'mkcert -install\n'
    exit 1
  fi

  if [[ ! $(command -v wp) ]]; then
    echo 'octopus ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ WP-CLI ãŒå¿…è¦ã§ã™ã€‚'
    echo 'ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ WP-CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚\n'
    echo 'curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar'
    echo 'php wp-cli.phar --info'
    echo 'chmod +x wp-cli.phar'
    echo 'sudo mv wp-cli.phar /usr/local/bin/wp\n'
    exit 1
  fi

  if [[ ! $(command -v pnpm) ]]; then
    echo 'octopus ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ pnpm ãŒå¿…è¦ã§ã™ã€‚'
    echo 'ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ pnpm ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚\n'
    echo 'brew install pnpm\n'
    exit 1
  fi

  # GitHubãƒ›ã‚¹ãƒˆåã®ç¢ºèªï¼†ç™»éŒ²
  if [ -z $(git config --global ssh.host) ]; then
    echo -n 'WEB DESIGN 84 GitHub SSH Host > '
    read github_ssh_host
    if [ -z "$github_ssh_host" ]; then
      echo 'GitHubã®SSHãƒ›ã‚¹ãƒˆåï¼ˆ~/.ssh/config ã«è¨˜è¿°ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
      exit 1
    elif [[ ! $(grep $github_ssh_host ~/.ssh/config) ]]; then
      echo '~/.ssh/config ã«ãƒ›ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'
      exit 1
    fi
    git config --global ssh.host $github_ssh_host
  fi

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
  echo -n 'Project Name > '
  read project_name
  if [ -z "$project_name" ]; then
    echo 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  elif [ -d $HOME/projects/$project_name ]; then
    echo 'æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€‚ä»–ã®åå‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'
    exit 1
  fi

  # ã‚µã‚¤ãƒˆå
  echo -n 'Site Title > '
  read site_title
  if [ -z "$site_title" ]; then
    echo 'ã‚µã‚¤ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  fi

  # ãƒ‰ãƒ¡ã‚¤ãƒ³å
  echo -n 'Domain > '
  read domain
  if [ -z "$domain" ]; then
    echo 'ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  elif grep -q "$domain" /etc/hosts; then
    echo "'$domain' ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚"
    echo '/etc/hosts ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ä»–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  fi

  # ãƒ›ã‚¹ãƒˆIP
  for i in {1..20}; do
    if ! grep -q "127.0.0.$i" /etc/hosts; then
      local ip="127.0.0.$i"
      break
    fi
  done
  if [ -z "$ip" ]; then
    echo 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç©ºããŒã‚ã‚Šã¾ã›ã‚“ã€‚'
    echo 'æ–°ãŸã«ç¢ºä¿ã™ã‚‹ã‹ã€ä¸ä½¿ç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  fi

  # ç¢ºèªå¾Œã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
  echo 'ä¸‹è¨˜ã®å†…å®¹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼ˆy/nï¼‰'
  echo '--------------------------'
  echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼š$project_name"
  echo "ã‚µã‚¤ãƒˆåï¼š$site_title"
  echo "ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š$domain"
  echo "ãƒ›ã‚¹ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š$ip"
  echo '--------------------------'
  if ! read -sq; then
    echo 'Octopusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚'
    exit
  fi

  # ~/projects ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ä½œæˆã™ã‚‹
  if [ ! -d $HOME/projects ]; then
    mkdir $HOME/projects
  fi

  # ~/projects/$project_name/dev ã«Octopusã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  cd $HOME/projects
  mkdir $project_name && cd $project_name
  git clone $(git config --global ssh.host):web-design-84/Octopus.git dev
  if [ ! -d $HOME/projects/$project_name/dev ]; then
    echo 'ã‚¯ãƒ­ãƒ¼ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
    echo 'GitHubã®ãƒ›ã‚¹ãƒˆåã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  fi

  # åˆæœŸè¨­å®š
  cd dev && rm -rf .git && mkdir {sql/db_data,mailhog}
  pnpm i

  # .env ã®æ›¸ãæ›ãˆ
  sed -i '' -e "s/^PRODUCTION_NAME=.*$/PRODUCTION_NAME=$project_name/" -e "s/^SITE_TITLE=.*$/SITE_TITLE='$site_title'/" -e "s/^DOMAIN=.*$/DOMAIN='$domain'/" -e "s/^HOST_IP=.*$/HOST_IP=$ip/" .env

  # è¨¼æ˜æ›¸ã®ä½œæˆ
  mkdir certs
  mkcert -cert-file ./certs/cert.pem -key-file ./certs/cert.key $domain

  # WordPressæ—¥æœ¬èªç‰ˆã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  wp core download --locale=ja

  # ã‚³ãƒ³ãƒ†ãƒŠã®ç«‹ã¡ä¸Šã’
  docker compose -p $project_name up -d --build

  # ç«‹ã¡ä¸ŠãŒã‚Šã‚’å¾…ã¤
  echo 'ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã®å®‰å®šã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚30ç§’ãŠå¾…ã¡ãã ã•ã„ğŸ™'
  for i in {1..10}; do
    # é€²æ—10%ã‚ãŸã‚Š "###" ã‚’å‡ºåŠ›
    local bar="$(yes '###' | head -n $i | tr -d '\n')"
    local spaces=''
    if [[ $i < 10 ]]; then
      local spaces=$(printf ".%0.s" {1..$((30 - ${#bar}))})
    fi
    printf "\r[%3d/100] %s%s" $((i * 10)) $bar $spaces
    sleep 3
  done
  printf '\n'

  # WP-CLIã«ã‚ˆã‚‹WordPressã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  docker exec "${project_name}_dev_wp" /bin/zsh setup-wp.sh

  # /etc/hosts ã«ãƒ›ã‚¹ãƒˆã‚’è¿½åŠ 
  echo 'honoka' | sudo -S -p '' zsh -c "echo \"# $site_title\n$ip $domain\n\" >> /etc/hosts"

  # å®Œäº†
  echo "~/projects/$project_name/dev ã¸Octopusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼"
  exit
}

#-------------------------------
# octopus ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã™ã‚‹
#-------------------------------

function octopus_destroy() {
  echo -n 'Project Name > '
  read project_name
  if [ -z "$project_name" ]; then
    echo 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    exit 1
  elif [ ! -d $HOME/projects/$project_name ]; then
    echo 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚'
    exit 1
  fi

  echo "$HOME/projects/$project_name ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆy/nï¼‰"
  if ! read -sq; then
    echo 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç ´æ£„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚'
    exit
  fi

  # Dockerã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤
  if [[ $(docker compose ls | awk 'NR>1{print $1}' | grep $project_name) ]]; then
    cd $HOME/projects/$project_name/dev
    docker compose -p $project_name down
  fi

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤
  if [[ $(docker images | awk 'NR>1{print $1}' | grep ${project_name}_wordpress) ]]; then
    docker rmi -f ${project_name}_wordpress
  fi

  # /etc/hosts ã‹ã‚‰å‰²ã‚Šå½“ã¦IPã‚’å‰Šé™¤
  local host_ip=$(ggrep -oP '127\.0\.0\.\d+$' $HOME/projects/$project_name/dev/.env)
  local line_count=$(ggrep -noP "^$host_ip" /etc/hosts | awk -F ':' '{print $1}')
  local delete_line_start=$( (expr $line_count - 1))
  local delete_line_end=$( (expr $line_count + 1))
  echo 'honoka' | sudo -S -p '' zsh -c "sed -i '' \"${delete_line_start},${delete_line_end}d\" /etc/hosts"

  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤
  cd $HOME/projects
  rm -rf $HOME/projects/$project_name

  echo 'Octopusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç ´æ£„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚'
}

#-------------------------------
# octopus ãƒ†ãƒ¼ãƒã‚’zipã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
#-------------------------------

function octopus_download() {
  # GitHubãƒ›ã‚¹ãƒˆåã®ç¢ºèªï¼†ç™»éŒ²
  local github_ssh_host=$(git config --global ssh.host)
  if [[ -z $github_ssh_host ]]; then
    echo -n 'WEB DESIGN 84 GitHub SSH Host > '
    read github_ssh_host
    if [ -z "$github_ssh_host" ]; then
      echo 'GitHubã®SSHãƒ›ã‚¹ãƒˆåï¼ˆ~/.ssh/config ã«è¨˜è¿°ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
      exit 1
    elif [[ ! $(grep $github_ssh_host ~/.ssh/config) ]]; then
      echo '~/.ssh/config ã«ãƒ›ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'
      exit 1
    fi
    git config --global ssh.host $github_ssh_host
  fi

  # tmp ãƒ•ã‚¡ã‚¤ãƒ«ã¸ octopus ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
  mkdir octopus-tmp && cd octopus-tmp
  git clone ${github_ssh_host}:web-design-84/octopus.git octopus-all

  # ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŠ½å‡ºã—ã€zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ~/Downloadsã«ç”Ÿæˆ
  mv octopus-all/wp-content/themes/octopus/ .
  rm -rf octopus-all
  zip -r octopus-theme.zip octopus/
  mv -f octopus-theme.zip ~/Downloads
  cd ../ && rm -rf octopus-tmp
}

#-------------------------------
# octopus ã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹
#-------------------------------

function octopus_help() {
  echo '
  â–  Sub commands
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  init      ~/projects ã¸Octopusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
  destroy   ~/projects ã®Octopusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç ´æ£„ã™ã‚‹
  download  ~/Downloads ã¸æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Octopusãƒ†ãƒ¼ãƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

  â–  Options
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  -v        ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  --help    ãƒ˜ãƒ«ãƒ—
  '
  exit
}

#-------------------------------
# octopus ã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
#-------------------------------

function octopus_version() {
  echo 'version 1.1.3'
  exit
}

#-------------------------------
# ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ¯ã‚Šåˆ†ã‘
#-------------------------------

while getopts vh:p:-: OPT; do
  case $OPT in
  v) octopus_version ;;
  -)
    case "${OPTARG}" in
    help) octopus_help ;;
    esac
    ;;
  esac
done

subcommand="$1"

case $subcommand in
init) octopus_init ;;
destroy) octopus_destroy ;;
download) octopus_download ;;
*)
  echo "ãƒ˜ãƒ«ãƒ—ã‚’å‚ç…§ã™ã‚‹ã«ã¯ã€ 'octopus --help' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
  exit 1
  ;;
esac
